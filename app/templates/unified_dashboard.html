<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UE5 AI Assistant - Control Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6ed;
            min-height: 100vh;
        }

        .header {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(0, 217, 255, 0.3);
            padding: 20px;
        }

        .header h1 {
            color: #00d9ff;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .project-selector {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-selector label {
            color: #8b95a5;
        }

        .project-selector select {
            padding: 8px 15px;
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #e0e6ed;
            font-size: 1em;
        }

        .project-status {
            padding: 8px 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #00d9ff;
        }

        .tabs {
            display: flex;
            background: rgba(26, 31, 58, 0.6);
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            color: #8b95a5;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
        }

        .tab.active {
            color: #00d9ff;
            border-bottom-color: #00d9ff;
        }

        .tab-content {
            display: none;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #00d9ff;
            margin-bottom: 15px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #8b95a5;
            font-size: 0.9em;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #e0e6ed;
            font-size: 1em;
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            border: none;
            border-radius: 6px;
            color: #0a0e27;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .output-box {
            background: rgba(10, 14, 39, 0.9);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .api-endpoint {
            background: rgba(10, 14, 39, 0.8);
            border-left: 3px solid #00d9ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .api-endpoint code {
            color: #00d9ff;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 217, 255, 0.1);
        }

        .feature-list li:before {
            content: "‚úÖ ";
            margin-right: 10px;
        }

        /* Loading and status styles */
        .status-loading {
            background: rgba(0, 217, 255, 0.1) !important;
            border: 1px solid rgba(0, 217, 255, 0.3) !important;
            color: #00d9ff !important;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
            color: #10b981 !important;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
            color: #ef4444 !important;
        }

        .status-warning {
            background: rgba(255, 107, 53, 0.2) !important;
            border: 1px solid rgba(255, 107, 53, 0.3) !important;
            color: #ff6b35 !important;
        }

        .status-info {
            background: rgba(0, 217, 255, 0.1) !important;
            border: 1px solid rgba(0, 217, 255, 0.3) !important;
            color: #00d9ff !important;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ UE5 AI Assistant - Control Center</h1>
        <div class="project-selector">
            <label>Active Project:</label>
            <select id="projectSelect" onchange="selectProject()">
                <option value="">No project selected</option>
            </select>
            <span class="project-status" id="projectStatus">Not connected</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('project-hub')">üéÆ Project Hub</button>
        <button class="tab" onclick="showTab('conversations')">üí¨ Conversations</button>
        <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        <button class="tab" onclick="showTab('api')">üîß API Info</button>
        <button class="tab" onclick="showTab('about')">‚ÑπÔ∏è About</button>
    </div>

    <!-- Project Hub Tab -->
    <div id="project-hub" class="tab-content active">
        <!-- Quick Action Bar -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
            <button onclick="toggleProjectForm()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding: 15px; font-size: 16px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                <span style="font-size: 24px;">‚ûï</span>
                <span>Add Project</span>
            </button>
            <button onclick="frictionlessDeploy()" style="background: linear-gradient(135deg, #ff6b35 0%, #f54023 100%); padding: 15px; font-size: 16px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                <span style="font-size: 24px;">‚ö°</span>
                <span>Quick Deploy</span>
            </button>
            <a href="/api/download_client" style="background: linear-gradient(135deg, #00d9ff 0%, #0891b2 100%); padding: 15px; font-size: 16px; display: flex; align-items: center; gap: 10px; justify-content: center; text-decoration: none; color: white; border-radius: 8px;">
                <span style="font-size: 24px;">üì¶</span>
                <span>Download Client</span>
            </a>
            <button onclick="showTab('settings'); triggerAutoUpdate()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px; font-size: 16px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                <span style="font-size: 24px;">üîÑ</span>
                <span>Update All</span>
            </button>
        </div>

        <!-- Project Registration Form (Collapsible) -->
        <div id="project-form" class="card" style="border: 2px solid rgba(139,92,246,0.3); display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">‚ûï Add New Project</h2>
                <button onclick="toggleProjectForm()" style="background: none; border: none; color: #8b95a5; font-size: 24px; cursor: pointer; padding: 0 10px;">√ó</button>
            </div>
            
            <div class="grid" style="gap: 15px;">
                <div class="input-group">
                    <label>Project Name</label>
                    <input type="text" id="manual-name" placeholder="UE5_Assistant" style="font-size: 16px; padding: 12px;">
                </div>
                
                <div class="input-group">
                    <label>Project Path</label>
                    <input type="text" id="manual-path" 
                        placeholder="D:/UnrealProjects/5.6/UE5_Assistant/"
                        list="recent-paths"
                        autocomplete="off"
                        style="font-size: 16px; padding: 12px;">
                    <datalist id="recent-paths"></datalist>
                    <small style="color: #8b95a5; margin-top: 5px; display: block;">üí° Path should end with /</small>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                <button onclick="registerManualProject()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 14px; font-size: 15px;">
                    ‚úÖ Register Project
                </button>
                <button onclick="frictionlessDeploy()" style="background: linear-gradient(135deg, #ff6b35 0%, #f54023 100%); padding: 14px; font-size: 15px;">
                    ‚ö° Instant Deploy & Run
                </button>
            </div>
            
            <div id="deploy-status" style="margin-top: 15px; display: none; padding: 15px; border-radius: 8px;"></div>
        </div>

        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
            <!-- AI Project Intelligence -->
            <div class="card" style="background: linear-gradient(135deg, rgba(0,217,255,0.05) 0%, rgba(0,0,0,0.2) 100%);">
                <h2>üß† AI Project Intelligence</h2>
                <p style="color: #8b95a5; margin-bottom: 15px;">Real-time AI queries with live UE5 data collection</p>
                
                <div class="input-group">
                    <input type="text" id="projectQuery" 
                        placeholder="Ask anything: file count, blueprints, project info..."
                        style="font-size: 16px; padding: 14px;">
                </div>

                <button onclick="queryProject()" style="width: 100%; padding: 14px; font-size: 16px; background: linear-gradient(135deg, #00d9ff 0%, #0891b2 100%);">
                    üîç Query Project
                </button>

                <div class="output-box" id="queryOutput" style="margin-top: 15px; min-height: 150px; max-height: 300px; font-size: 14px;">
                    Response will appear here...
                </div>
            </div>

            <!-- AI Agent Utility Generator -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(0,0,0,0.2) 100%);">
                <h2>üõ†Ô∏è AI Utility Generator</h2>
                <p style="color: #8b95a5; margin-bottom: 15px;">Generate UE5.6 Editor Utilities with AI backend integration</p>

                <div class="input-group">
                    <label>Utility Name</label>
                    <input type="text" id="utilityName" 
                        placeholder="SmartSceneBuilder">
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <textarea id="utilityDesc" 
                        placeholder="AI-powered scene builder"></textarea>
                </div>

                <button onclick="generateUtility()">‚ú® Generate Utility</button>

                <div class="output-box" id="utilityOutput" style="margin-top: 15px;">
                    Generation result will appear here...
                </div>
            </div>
        </div>
    </div>

    <!-- Conversations Tab -->
    <div id="conversations" class="tab-content">
        <div class="card">
            <h2>üí¨ Conversation History</h2>
            
            <!-- Search and Filter Controls -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="conversationSearch" placeholder="üîç Search conversations..." 
                    style="flex: 1;" onkeyup="filterConversations()">
                
                <select id="conversationProjectFilter" onchange="filterConversations()">
                    <option value="">All Projects</option>
                </select>
                
                <select id="conversationTypeFilter" onchange="filterConversations()">
                    <option value="">All Types</option>
                    <option value="execute_command">Commands</option>
                    <option value="project_query">Project Queries</option>
                    <option value="describe_viewport">Viewport Description</option>
                    <option value="guidance">Guidance</option>
                </select>
                
                <button onclick="confirmClearHistory()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    üóëÔ∏è Clear History
                </button>
            </div>
            
            <!-- Conversation Statistics -->
            <div id="conversationStats" style="padding: 10px; background: rgba(10, 14, 39, 0.6); border-radius: 6px; margin-bottom: 15px;">
                <span style="color: #8b95a5;">Total: <span id="totalConversations" style="color: #00d9ff;">0</span></span> | 
                <span style="color: #8b95a5;">Filtered: <span id="filteredConversations" style="color: #00d9ff;">0</span></span> | 
                <span style="color: #8b95a5;">Active Project: <span id="activeProjectName" style="color: #10b981;">None</span></span>
            </div>
            
            <!-- Conversation List -->
            <div id="conversation-list" style="max-height: 600px; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; color: #8b95a5;">
                    <p>Loading conversations...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="card">
            <h2>‚öôÔ∏è Configuration Settings</h2>
            
            <div class="grid">
                <!-- AI Configuration -->
                <div>
                    <h3 style="color: #00d9ff; margin-bottom: 15px;">ü§ñ AI Configuration</h3>
                    
                    <div class="input-group">
                        <label>AI Model</label>
                        <select id="modelSelect">
                            <option value="gpt-4o-mini">GPT-4o Mini (Fast, Cost-effective)</option>
                            <option value="gpt-4o">GPT-4o (Advanced)</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Response Style</label>
                        <select id="styleSelect">
                            <option value="concise">Concise</option>
                            <option value="balanced">Balanced</option>
                            <option value="detailed">Detailed</option>
                            <option value="technical">Technical</option>
                            <option value="descriptive">Descriptive</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Temperature (Creativity): <span id="tempValue">0.7</span></label>
                        <input type="range" id="tempSlider" min="0" max="1" step="0.1" value="0.7" 
                            oninput="document.getElementById('tempValue').textContent = this.value"
                            style="width: 100%; padding: 0;">
                    </div>
                    
                    <div class="input-group">
                        <label>Max Tokens (Response Length): <span id="maxTokensValue">1500</span></label>
                        <input type="range" id="maxTokensSlider" min="500" max="4000" step="100" value="1500" 
                            oninput="document.getElementById('maxTokensValue').textContent = this.value"
                            style="width: 100%; padding: 0;">
                    </div>
                </div>
                
                <!-- System Configuration -->
                <div>
                    <h3 style="color: #00d9ff; margin-bottom: 15px;">‚öôÔ∏è System Settings</h3>
                    
                    <div class="input-group">
                        <label>Backend URL (for local testing)</label>
                        <input type="text" id="backendUrl" placeholder="http://localhost:5000" 
                            value="https://ue5-assistant-noahbutcher97.replit.app">
                    </div>
                    
                    <div class="input-group">
                        <label>Max Context Turns</label>
                        <input type="number" id="maxContextTurns" min="1" max="20" value="6">
                    </div>
                    
                    <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="verboseLogging" style="width: auto;">
                        <label for="verboseLogging" style="margin: 0;">Enable Verbose Logging</label>
                    </div>
                    
                    <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoScroll" style="width: auto;" checked>
                        <label for="autoScroll" style="margin: 0;">Auto-scroll Conversations</label>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveSettings()">üíæ Save Settings</button>
                <button onclick="resetToDefaults()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    üîÑ Reset to Defaults
                </button>
                <button onclick="testOpenAIConnection()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üîå Test OpenAI Connection
                </button>
                <button onclick="triggerAutoUpdate()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                    üì¢ Trigger UE5 Auto-Update
                </button>
            </div>
            
            <div id="settings-status" style="margin-top: 15px; display: none; padding: 12px; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- API Info Tab -->
    <div id="api" class="tab-content">
        <div class="card">
            <h2>üîß API Endpoints & Status</h2>
            
            <!-- System Status -->
            <div style="padding: 15px; background: rgba(10, 14, 39, 0.8); border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d9ff; margin-top: 0;">üìä System Status</h3>
                <div id="system-status" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <span style="color: #8b95a5;">Backend:</span>
                        <span id="backend-status" style="margin-left: 10px;">Checking...</span>
                    </div>
                    <div>
                        <span style="color: #8b95a5;">Deploy Agent:</span>
                        <span id="deploy-agent-status" style="margin-left: 10px;">Checking...</span>
                    </div>
                    <div>
                        <span style="color: #8b95a5;">Version:</span>
                        <span id="version-info" style="margin-left: 10px;">v3.2</span>
                    </div>
                    <div>
                        <span style="color: #8b95a5;">OpenAI API:</span>
                        <span id="openai-status" style="margin-left: 10px;">Checking...</span>
                    </div>
                </div>
            </div>
            
            <h3 style="color: #00d9ff; margin-top: 20px;">üîç Health Check Endpoints</h3>
            <div class="api-endpoint">
                <code>GET /health</code>
                <p>Check backend health status</p>
                <button onclick="testEndpoint('/health', 'GET')" style="padding: 6px 12px; font-size: 0.9em;">Test</button>
            </div>
            <div class="api-endpoint">
                <code>GET /ping_openai</code>
                <p>Test OpenAI API connectivity</p>
                <button onclick="testEndpoint('/ping_openai', 'GET')" style="padding: 6px 12px; font-size: 0.9em;">Test</button>
            </div>

            <h3 style="color: #00d9ff; margin-top: 20px;">üì¶ Project Management</h3>
            <div class="api-endpoint">
                <code>POST /api/register_project</code>
                <p>Register UE5 project from client</p>
            </div>
            <div class="api-endpoint">
                <code>GET /api/projects</code>
                <p>List all registered projects</p>
                <button onclick="testEndpoint('/api/projects', 'GET')" style="padding: 6px 12px; font-size: 0.9em;">Test</button>
            </div>
            <div class="api-endpoint">
                <code>POST /api/set_active_project</code>
                <p>Set active project for queries</p>
            </div>

            <h3 style="color: #00d9ff; margin-top: 20px;">ü§ñ AI Interaction</h3>
            <div class="api-endpoint">
                <code>POST /execute_command</code>
                <p>Send commands to AI (supports "prompt" or "user_input")</p>
            </div>
            <div class="api-endpoint">
                <code>POST /api/project_query</code>
                <p>Query active project with AI</p>
            </div>

            <h3 style="color: #00d9ff; margin-top: 20px;">üõ†Ô∏è Utility Generation</h3>
            <div class="api-endpoint">
                <code>POST /api/generate_utility</code>
                <p>Generate AI agent editor utilities</p>
            </div>
            <div class="api-endpoint">
                <code>POST /api/generate_action_plan</code>
                <p>Generate scene building action plans</p>
            </div>
            
            <h3 style="color: #00d9ff; margin-top: 20px;">üí¨ Conversation Management</h3>
            <div class="api-endpoint">
                <code>GET /api/conversations</code>
                <p>Get conversation history</p>
                <button onclick="testEndpoint('/api/conversations?limit=5', 'GET')" style="padding: 6px 12px; font-size: 0.9em;">Test</button>
            </div>
            <div class="api-endpoint">
                <code>DELETE /api/conversations</code>
                <p>Clear all conversation history</p>
            </div>
            
            <div id="api-test-result" style="margin-top: 20px; padding: 15px; background: rgba(10, 14, 39, 0.9); border-radius: 8px; display: none;">
                <h4 style="color: #00d9ff; margin-top: 0;">Test Result:</h4>
                <pre id="api-test-output" style="white-space: pre-wrap; color: #8b95a5;"></pre>
            </div>
        </div>
    </div>

    <!-- About Tab -->
    <div id="about" class="tab-content">
        <div class="card">
            <h2>‚ÑπÔ∏è About UE5 AI Assistant v3.2</h2>
            
            <h3 style="color: #00d9ff; margin: 20px 0 10px;">‚ú® Latest Features</h3>
            <ul class="feature-list">
                <li><strong>Deploy Agent</strong> - Frictionless one-click deployment from browser</li>
                <li><strong>File System Access API</strong> - Direct browser deployment without downloads</li>
                <li><strong>Auto-initialization</strong> - Client automatically registers projects on startup</li>
                <li><strong>UE5 Local Server</strong> - Run AI backend locally for offline development</li>
                <li><strong>Protocol Handler</strong> - Deploy via ue5assistant:// URLs</li>
                <li><strong>Multi-project Management</strong> - Switch between projects seamlessly</li>
                <li><strong>Context-aware AI</strong> - Responses tailored to active project</li>
                <li><strong>Editor Utility Generation</strong> - Create AI-powered UE5.6 utilities</li>
                <li><strong>Scene Orchestration</strong> - Spawn and arrange actors programmatically</li>
                <li><strong>Blueprint Analysis</strong> - Capture and analyze Blueprint graphs</li>
            </ul>

            <h3 style="color: #00d9ff; margin: 20px 0 10px;">üìö Quick Links</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <a href="/deploy/modern" target="_blank" style="padding: 10px; background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; text-align: center; color: #00d9ff; text-decoration: none;">
                    ‚ú® Modern Deploy Page
                </a>
                <a href="/api/download_client" style="padding: 10px; background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; text-align: center; color: #00d9ff; text-decoration: none;">
                    üì¶ Download Client ZIP
                </a>
                <a href="/api/installer_script" style="padding: 10px; background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; text-align: center; color: #00d9ff; text-decoration: none;">
                    ‚ö° PowerShell Installer
                </a>
                <a href="/api/protocol_handler" style="padding: 10px; background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 6px; text-align: center; color: #00d9ff; text-decoration: none;">
                    üîó Protocol Handler
                </a>
            </div>

            <h3 style="color: #00d9ff; margin: 20px 0 10px;">üíª System Requirements</h3>
            <ul class="feature-list">
                <li><strong>Unreal Engine:</strong> 5.6 or later</li>
                <li><strong>Python:</strong> 3.11+ (included with UE5)</li>
                <li><strong>Browser:</strong> Chrome/Edge (for File System API deployment)</li>
                <li><strong>Memory:</strong> 16GB RAM recommended</li>
                <li><strong>OS:</strong> Windows 10/11</li>
            </ul>

            <h3 style="color: #00d9ff; margin: 20px 0 10px;">üîß Troubleshooting Tips</h3>
            <div style="background: rgba(255, 107, 53, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 107, 53, 0.3);">
                <p style="margin: 0 0 10px 0;"><strong>Client not connecting?</strong></p>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Verify backend URL in AIAssistant/config.py</li>
                    <li>Check UE5 Output Log for error messages</li>
                    <li>Ensure Python plugin is enabled in UE5</li>
                </ul>
                
                <p style="margin: 15px 0 10px 0;"><strong>Deploy Agent issues?</strong></p>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Ensure Deploy Agent is running on port 7865</li>
                    <li>Check Windows firewall isn't blocking local connections</li>
                    <li>Run Deploy Agent as Administrator if permission issues</li>
                </ul>
                
                <p style="margin: 15px 0 10px 0;"><strong>AI responses not working?</strong></p>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Test OpenAI connection in Settings tab</li>
                    <li>Verify API key is set in backend environment</li>
                    <li>Check conversation history for error messages</li>
                </ul>
            </div>

            <h3 style="color: #00d9ff; margin: 20px 0 10px;">üèóÔ∏è Architecture</h3>
            <p style="line-height: 1.8; color: #8b95a5;">
                The system uses a <strong>client-server architecture</strong> with a FastAPI backend 
                (hosted on Replit) and UE5 Python client. The client auto-registers projects and 
                uploads metadata. The web dashboard provides project management and AI querying 
                capabilities from any browser.
            </p>

            <h3 style="color: #00d9ff; margin: 20px 0 10px;">üìû Support</h3>
            <p style="color: #8b95a5;">
                For issues or feature requests, check the project documentation or contact support. 
                The system is actively maintained and regularly updated with new capabilities.
            </p>
        </div>
    </div>

    <script>
        let currentTab = 'project-hub';

        // Load projects on page load
        loadProjects();
        loadConversations();
        loadConfig();
        loadRecentPaths();

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            
            // Run specific actions based on tab
            if (tabName === 'api') {
                checkSystemStatus();
            } else if (tabName === 'conversations') {
                if (allConversations.length === 0) {
                    loadConversations();
                }
            } else if (tabName === 'settings') {
                loadConfig();
            }
        }

        function toggleProjectForm() {
            const form = document.getElementById('project-form');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">No project selected</option>';
                
                if (data.success && data.projects.length > 0) {
                    data.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.project_id;
                        option.textContent = `${project.name} (${project.version})`;
                        if (project.is_active) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    // Update connection status based on actual WebSocket connections
                    updateConnectionIndicator();
                } else {
                    // Auto-show project form if no projects
                    const form = document.getElementById('project-form');
                    if (form) form.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load projects:', error);
            }
        }
        
        function loadRecentPaths() {
            try {
                const recentPaths = JSON.parse(localStorage.getItem('ue5_recent_paths') || '[]');
                const datalist = document.getElementById('recent-paths');
                datalist.innerHTML = '';
                
                recentPaths.forEach(path => {
                    const option = document.createElement('option');
                    option.value = path;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load recent paths:', error);
            }
        }
        
        function saveRecentPath(path) {
            try {
                let recentPaths = JSON.parse(localStorage.getItem('ue5_recent_paths') || '[]');
                
                // Remove if already exists
                recentPaths = recentPaths.filter(p => p !== path);
                
                // Add to beginning
                recentPaths.unshift(path);
                
                // Keep only last 10
                recentPaths = recentPaths.slice(0, 10);
                
                localStorage.setItem('ue5_recent_paths', JSON.stringify(recentPaths));
                loadRecentPaths();
            } catch (error) {
                console.error('Failed to save recent path:', error);
            }
        }
        
        async function registerManualProject() {
            const name = document.getElementById('manual-name').value;
            let path = document.getElementById('manual-path').value;
            
            if (!name || !path) {
                alert('Please enter both project name and path');
                return;
            }
            
            // Ensure path ends with /
            if (!path.endsWith('/') && !path.endsWith('\\')) {
                path = path + '/';
            }
            
            try {
                const response = await fetch('/api/register_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        path: path,
                        version: "5.6",
                        metadata: {
                            manually_registered: true,
                            registration_time: new Date().toISOString()
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Save to recent paths
                    saveRecentPath(path);
                    
                    alert(`‚úÖ Project "${name}" registered successfully!`);
                    // DO NOT clear the fields - keep them populated for immediate deploy
                    // document.getElementById('manual-name').value = '';
                    // document.getElementById('manual-path').value = '';
                    await loadProjects();
                } else {
                    alert(`‚ùå Registration failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        // Helper function to update deploy status
        function updateDeployStatus(message, type = 'info') {
            const statusDiv = document.getElementById('deploy-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message;
            statusDiv.className = `status-${type}`;
        }
        
        async function frictionlessDeploy() {
        const projectName = document.getElementById('manual-name').value;
        const projectPath = document.getElementById('manual-path').value;
        
        // Show immediate feedback
        const statusDiv = document.getElementById('deploy-status');
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-loading';
        statusDiv.innerHTML = '<span class="loading-spinner">‚öôÔ∏è</span> Starting deployment process...';
        
        if (!projectPath) {
            statusDiv.className = 'status-error';
            statusDiv.innerHTML = '‚ùå Please enter the project path first';
            return;
        }
        
        // First, check if Deploy Agent is running
        try {
            await new Promise(resolve => setTimeout(resolve, 500)); // Brief delay to show loading state
            statusDiv.innerHTML = '<span class="loading-spinner">üîç</span> Checking for Deploy Agent on your PC...';
            statusDiv.className = 'status-loading';
            
            const agentResponse = await fetch('http://localhost:7865/status');
            
            if (agentResponse.ok) {
                // Agent is running! Do frictionless deploy
                statusDiv.innerHTML = '<span class="loading-spinner">‚ö°</span> Deploy Agent found! Starting instant deployment...';
                statusDiv.className = 'status-loading';
                
                const deployResponse = await fetch('http://localhost:7865/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_path: projectPath,
                        auto_import: true
                    })
                });
                
                const result = await deployResponse.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin: 20px 0;">üéâ</div>
                            <h3 style="color: #00ff88; margin: 10px 0;">Instant Deployment Complete!</h3>
                            <p>‚úÖ ${result.files_deployed} files deployed</p>
                            <p>‚úÖ AI Assistant auto-imported in UE5</p>
                            <p style="font-size: 18px; color: #00d9ff; margin-top: 20px;">
                                üöÄ Your AI Assistant is ready to use in Unreal Engine!
                            </p>
                        </div>
                    `;
                    statusDiv.className = 'status-success';
                    
                    // Auto-register the project too
                    setTimeout(() => registerManualProject(), 2000);
                } else {
                    throw new Error(result.error || 'Deployment failed');
                }
                
            } else {
                throw new Error('Deploy Agent not running');
            }
            
        } catch (error) {
            // Agent not running - show instructions to set it up
            statusDiv.innerHTML = `
                <div style="background: rgba(255, 107, 53, 0.1); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 107, 53, 0.3);">
                    <h3 style="color: #ff6b35; margin-top: 0;">‚ö° One-Time Setup Required</h3>
                    <p style="color: #8b95a5;">To enable instant deployment, run the Deploy Agent on your PC:</p>
                    
                    <div style="background: #0a1628; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <code style="color: #00d9ff;">
                            <strong>Option A (Easiest):</strong><br>
                            1. Download: <a href="/api/deploy_agent_installer" style="color: #ff6b35;">deploy_agent_installer.bat</a><br>
                            2. Double-click the .bat file<br>
                            3. Enter your project path when prompted<br>
                            <br>
                            <strong>Option B (Manual):</strong><br>
                            1. Download: <a href="/api/deploy_agent" style="color: #ff6b35;">deploy_agent.py</a><br>
                            2. Run: python deploy_agent.py --ue5-project "${projectPath}"
                        </code>
                    </div>
                    
                    <p style="color: #8b95a5; font-size: 14px;">
                        The Deploy Agent runs locally and enables:<br>
                        ‚Ä¢ Instant deployment from browser<br>
                        ‚Ä¢ Auto-import in UE5<br>
                        ‚Ä¢ Zero manual steps<br>
                    </p>
                    
                    <button onclick="deployClient()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; margin-top: 10px;">
                        Use Classic Deploy Instead
                    </button>
                </div>
            `;
            statusDiv.className = 'status-warning';
        }
    }
    
    async function deployClient() {
            let path = document.getElementById('manual-path').value;
            
            if (!path) {
                alert('Please enter the project path first');
                return;
            }
            
            // Ensure path ends with /
            if (!path.endsWith('/') && !path.endsWith('\\')) {
                path = path + '/';
            }
            
            const statusDiv = document.getElementById('deploy-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(139, 92, 246, 0.2)';
            statusDiv.style.color = '#a78bfa';
            statusDiv.innerHTML = 'üöÄ Attempting to deploy client files...';
            
            try {
                const response = await fetch('/api/deploy_client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_path: path,
                        overwrite: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const overwroteMsg = data.overwrote_existing ? 
                        `<br><small>‚ö†Ô∏è Overwrote ${data.overwrote_existing} existing file(s)</small>` : 
                        `<br><small>‚ú® Deployed to empty directory</small>`;
                    
                    statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusDiv.style.color = '#10b981';
                    statusDiv.innerHTML = `
                        ‚úÖ ${data.message}${overwroteMsg}<br>
                        <small>üìÅ Deployed to: ${data.target_path}</small><br>
                        <strong>Next steps:</strong>
                        <ol style="margin: 10px 0 0 20px; text-align: left;">
                            ${data.instructions.map(i => `<li>${i}</li>`).join('')}
                        </ol>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #8b95a5;">View deployed files (${data.files_copied.length})</summary>
                            <pre style="margin: 5px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 11px; max-height: 150px; overflow-y: auto;">${data.files_copied.join('\n')}</pre>
                        </details>
                    `;
                    
                    saveRecentPath(path);
                } else {
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusDiv.style.color = '#ef4444';
                    statusDiv.innerHTML = `
                        ‚ùå ${data.error}<br>
                        <small>‚ö†Ô∏è Browser cannot access local file system. Use manual download instead.</small><br>
                        <a href="/api/download_client" style="color: #00d9ff; text-decoration: underline;">üì¶ Download ZIP File</a>
                    `;
                }
            } catch (error) {
                statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                statusDiv.style.color = '#ef4444';
                statusDiv.innerHTML = `
                    ‚ùå Deployment failed: ${error.message}<br>
                    <small>‚ö†Ô∏è Browser cannot access local files. Please download ZIP manually.</small><br>
                    <a href="/api/download_client" style="color: #00d9ff; text-decoration: underline;">üì¶ Download ZIP File</a>
                `;
            }
        }

        async function selectProject() {
            const projectId = document.getElementById('projectSelect').value;
            
            if (!projectId) {
                document.getElementById('projectStatus').textContent = 'Not connected';
                return;
            }

            try {
                const response = await fetch('/api/set_active_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId })
                });

                const data = await response.json();
                
                if (data.success) {
                    updateProjectStatus(data.project);
                }
            } catch (error) {
                console.error('Failed to set active project:', error);
            }
        }

        function updateProjectStatus(project) {
            const status = document.getElementById('projectStatus');
            status.textContent = `‚úÖ ${project.name} Connected`;
            status.style.background = 'rgba(0, 255, 136, 0.1)';
            status.style.borderColor = 'rgba(0, 255, 136, 0.3)';
            status.style.color = '#00ff88';
        }

        // WebSocket for real-time UE5 communication
        let dashboardWs = null;
        let wsConnected = false;
        let ue5ProjectsConnected = [];

        function initWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/dashboard`;
            
            dashboardWs = new WebSocket(wsUrl);
            
            dashboardWs.onopen = () => {
                console.log('‚úÖ Dashboard WebSocket connected');
                wsConnected = true;
                updateConnectionIndicator();
            };
            
            dashboardWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            dashboardWs.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                wsConnected = false;
                updateConnectionIndicator();
            };
            
            dashboardWs.onclose = () => {
                console.log('üîå WebSocket closed, reconnecting...');
                wsConnected = false;
                updateConnectionIndicator();
                setTimeout(initWebSocket, 5000); // Reconnect after 5s
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'initial_status') {
                ue5ProjectsConnected = data.connected_projects || [];
                updateConnectionIndicator();
            } else if (data.type === 'ue5_status') {
                if (data.status === 'connected') {
                    if (!ue5ProjectsConnected.includes(data.project_id)) {
                        ue5ProjectsConnected.push(data.project_id);
                    }
                } else {
                    ue5ProjectsConnected = ue5ProjectsConnected.filter(id => id !== data.project_id);
                }
                updateConnectionIndicator();
            } else if (data.type === 'action_result') {
                console.log('Action result:', data);
            }
        }

        function updateConnectionIndicator() {
            const status = document.getElementById('projectStatus');
            if (wsConnected && ue5ProjectsConnected.length > 0) {
                status.innerHTML = `üåê Real-time: ${ue5ProjectsConnected.length} UE5 client(s) connected`;
                status.style.background = 'rgba(0, 255, 136, 0.1)';
                status.style.borderColor = 'rgba(0, 255, 136, 0.3)';
                status.style.color = '#00ff88';
            } else if (wsConnected) {
                status.innerHTML = '‚ö†Ô∏è WebSocket ready, no UE5 clients';
                status.style.background = 'rgba(251, 191, 36, 0.1)';
                status.style.borderColor = 'rgba(251, 191, 36, 0.3)';
                status.style.color = '#fbbf24';
            } else {
                status.innerHTML = '‚ùå Not connected';
                status.style.background = 'rgba(239, 68, 68, 0.1)';
                status.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                status.style.color = '#ef4444';
            }
        }

        async function queryProject() {
            const query = document.getElementById('projectQuery').value;
            const output = document.getElementById('queryOutput');

            if (!query) {
                output.textContent = 'Please enter a question';
                return;
            }

            output.textContent = 'Querying AI...';

            // First, ask AI what to do
            try {
                const response = await fetch('/api/project_query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                
                if (data.error) {
                    output.textContent = `Error: ${data.error}`;
                    return;
                }

                // Check if AI wants to execute an action in UE5
                if (data.ue_request && wsConnected && ue5ProjectsConnected.length > 0) {
                    output.textContent = 'üîÑ Collecting live data from UE5...';
                    
                    // Get active project
                    const projectId = document.getElementById('projectSelect').value;
                    
                    if (projectId && ue5ProjectsConnected.includes(projectId)) {
                        // Execute action via WebSocket
                        const actionResult = await executeUE5Action(projectId, data.ue_request, {});
                        
                        if (actionResult.success) {
                            output.textContent = `‚úÖ Live data retrieved:\n\n${JSON.stringify(actionResult.data, null, 2)}`;
                        } else {
                            output.textContent = `‚ùå Failed to collect data: ${actionResult.error}`;
                        }
                    } else {
                        output.textContent = data.response;
                    }
                } else {
                    const context = data.project_context ? `[${data.project_context}]\n\n` : '';
                    output.textContent = context + data.response;
                }
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
            }
        }

        function executeUE5Action(projectId, action, params) {
            return new Promise((resolve, reject) => {
                if (!dashboardWs || !wsConnected) {
                    reject(new Error('WebSocket not connected'));
                    return;
                }

                const requestId = `req_${Date.now()}`;
                
                // Send command
                dashboardWs.send(JSON.stringify({
                    type: 'execute_action',
                    project_id: projectId,
                    action: action,
                    params: params
                }));

                // Listen for response
                const messageHandler = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'action_result' && data.action === action) {
                        dashboardWs.removeEventListener('message', messageHandler);
                        resolve(data.result);
                    }
                };

                dashboardWs.addEventListener('message', messageHandler);

                // Timeout after 30s
                setTimeout(() => {
                    dashboardWs.removeEventListener('message', messageHandler);
                    reject(new Error('Action timeout'));
                }, 30000);
            });
        }

        async function generateUtility() {
            const name = document.getElementById('utilityName').value;
            const desc = document.getElementById('utilityDesc').value;
            const output = document.getElementById('utilityOutput');

            if (!name || !desc) {
                output.textContent = 'Please fill in name and description';
                return;
            }

            output.textContent = 'Generating utility...';

            try {
                const response = await fetch('/api/generate_utility', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, 
                        description: desc, 
                        capabilities: ['spawn_actors', 'execute_plans'] 
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    output.textContent = `Error: ${data.error}`;
                } else {
                    output.textContent = `‚úÖ Generated: ${data.widget_name}\n\n` +
                        `üìÅ Script Path: ${data.script_path}\n\n` +
                        `To use:\n1. Download AIAssistant folder\n2. Restart Unreal Editor\n3. Run the utility`;
                }
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
            }
        }

        // Enhanced conversation management
        let allConversations = [];
        let filteredConversationsList = [];

        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations?limit=50');
                const data = await response.json();
                
                if (data.conversations) {
                    allConversations = data.conversations;
                    
                    // Update project filter dropdown
                    const projectFilter = document.getElementById('conversationProjectFilter');
                    const uniqueProjects = [...new Set(data.conversations
                        .filter(c => c.metadata && c.metadata.project_context)
                        .map(c => c.metadata.project_context))];
                    
                    if (uniqueProjects.length > 0) {
                        projectFilter.innerHTML = '<option value="">All Projects</option>';
                        uniqueProjects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project;
                            option.textContent = project;
                            projectFilter.appendChild(option);
                        });
                    }
                    
                    // Apply filters and display
                    filterConversations();
                    
                    // Update statistics
                    document.getElementById('totalConversations').textContent = data.total || allConversations.length;
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                document.getElementById('conversation-list').innerHTML = 
                    '<div style="padding: 20px; color: #ef4444;">Failed to load conversations</div>';
            }
        }

        function filterConversations() {
            const searchText = document.getElementById('conversationSearch')?.value?.toLowerCase() || '';
            const projectFilter = document.getElementById('conversationProjectFilter')?.value || '';
            const typeFilter = document.getElementById('conversationTypeFilter')?.value || '';
            
            filteredConversationsList = allConversations.filter(conv => {
                // Search filter
                if (searchText && !conv.user_input.toLowerCase().includes(searchText) && 
                    !conv.assistant_response.toLowerCase().includes(searchText)) {
                    return false;
                }
                
                // Project filter
                if (projectFilter && conv.metadata && conv.metadata.project_context !== projectFilter) {
                    return false;
                }
                
                // Type filter
                if (typeFilter && conv.command_type !== typeFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Update filtered count
            document.getElementById('filteredConversations').textContent = filteredConversationsList.length;
            
            // Display filtered conversations
            const listEl = document.getElementById('conversation-list');
            
            if (filteredConversationsList.length === 0) {
                listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #8b95a5;">No matching conversations found</div>';
                return;
            }
            
            listEl.innerHTML = filteredConversationsList.map(conv => {
                const timestamp = new Date(conv.timestamp).toLocaleString();
                const responseLength = conv.assistant_response.length;
                const projectContext = conv.metadata?.project_context || 'No project';
                const isError = conv.metadata?.error;
                
                return `
                    <div style="border: 1px solid rgba(0, 217, 255, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; background: rgba(26, 31, 58, 0.4);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #00d9ff; font-size: 0.9em;">${timestamp}</span>
                            <div style="display: flex; gap: 10px;">
                                <span style="padding: 2px 8px; background: rgba(0, 217, 255, 0.1); border-radius: 4px; font-size: 0.85em; color: #8b95a5;">
                                    ${conv.command_type}
                                </span>
                                <span style="padding: 2px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; font-size: 0.85em; color: #10b981;">
                                    ${projectContext}
                                </span>
                                ${isError ? '<span style="padding: 2px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; font-size: 0.85em; color: #ef4444;">Error</span>' : ''}
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #8b95a5;">User:</strong>
                            <div style="margin: 5px 0; padding: 10px; background: rgba(10, 14, 39, 0.6); border-radius: 4px;">
                                ${conv.user_input}
                            </div>
                        </div>
                        <div>
                            <strong style="color: #8b95a5;">Assistant (${responseLength} chars):</strong>
                            <div style="margin: 5px 0; padding: 10px; background: rgba(10, 14, 39, 0.6); border-radius: 4px; max-height: 200px; overflow-y: auto;">
                                ${conv.assistant_response}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Auto-scroll if enabled
            if (document.getElementById('autoScroll')?.checked) {
                listEl.scrollTop = listEl.scrollHeight;
            }
        }

        async function confirmClearHistory() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear all conversation history? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/conversations', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Conversation history cleared successfully');
                    allConversations = [];
                    filterConversations();
                    document.getElementById('totalConversations').textContent = '0';
                } else {
                    alert('‚ùå Failed to clear history: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error clearing history: ' + error.message);
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.config) {
                    // Update UI with current config
                    document.getElementById('modelSelect').value = data.config.model || 'gpt-4o-mini';
                    document.getElementById('styleSelect').value = data.config.response_style || 'balanced';
                    document.getElementById('tempSlider').value = data.config.temperature || 0.7;
                    document.getElementById('tempValue').textContent = data.config.temperature || 0.7;
                    document.getElementById('maxContextTurns').value = data.config.max_context_turns || 6;
                    
                    // Update active project in conversations
                    loadActiveProject();
                }
                
                // Check system status when API tab is shown
                if (currentTab === 'api') {
                    checkSystemStatus();
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        async function loadActiveProject() {
            try {
                const response = await fetch('/api/active_project');
                const data = await response.json();
                
                if (data.success && data.project) {
                    document.getElementById('activeProjectName').textContent = data.project.name;
                } else {
                    document.getElementById('activeProjectName').textContent = 'None';
                }
            } catch (error) {
                console.error('Failed to load active project:', error);
            }
        }

        async function saveSettings() {
            const statusDiv = document.getElementById('settings-status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-loading';
            statusDiv.textContent = 'Saving settings...';
            
            try {
                const config = {
                    model: document.getElementById('modelSelect').value,
                    response_style: document.getElementById('styleSelect').value,
                    temperature: parseFloat(document.getElementById('tempSlider').value),
                    max_context_turns: parseInt(document.getElementById('maxContextTurns').value)
                };
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status-success';
                    statusDiv.textContent = '‚úÖ Settings saved successfully!';
                    
                    // Save local preferences
                    localStorage.setItem('ue5_verbose_logging', document.getElementById('verboseLogging').checked);
                    localStorage.setItem('ue5_auto_scroll', document.getElementById('autoScroll').checked);
                    localStorage.setItem('ue5_backend_url', document.getElementById('backendUrl').value);
                } else {
                    throw new Error('Failed to save settings');
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                statusDiv.className = 'status-error';
                statusDiv.textContent = '‚ùå Failed to save settings: ' + error.message;
            }
        }

        async function resetToDefaults() {
            if (!confirm('Reset all settings to default values?')) {
                return;
            }
            
            // Reset UI to defaults
            document.getElementById('modelSelect').value = 'gpt-4o-mini';
            document.getElementById('styleSelect').value = 'balanced';
            document.getElementById('tempSlider').value = 0.7;
            document.getElementById('tempValue').textContent = '0.7';
            document.getElementById('maxTokensSlider').value = 1500;
            document.getElementById('maxTokensValue').textContent = '1500';
            document.getElementById('maxContextTurns').value = 6;
            document.getElementById('verboseLogging').checked = false;
            document.getElementById('autoScroll').checked = true;
            document.getElementById('backendUrl').value = 'https://ue5-assistant-noahbutcher97.replit.app';
            
            // Save to backend
            saveSettings();
        }

        async function testOpenAIConnection() {
            const statusDiv = document.getElementById('settings-status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-loading';
            statusDiv.textContent = 'Testing OpenAI connection...';
            
            try {
                const response = await fetch('/ping_openai');
                const result = await response.json();
                
                if (result.openai_status === 'connected') {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `‚úÖ OpenAI connected! Response: ${result.response || 'pong'}`;
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.textContent = '‚ùå ' + (result.error || 'Connection failed');
                }
            } catch (error) {
                statusDiv.className = 'status-error';
                statusDiv.textContent = '‚ùå Connection test failed: ' + error.message;
            }
        }

        async function triggerAutoUpdate() {
            const statusDiv = document.getElementById('settings-status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-loading';
            statusDiv.innerHTML = 'üì¢ Triggering auto-update for connected UE5 clients...';
            
            try {
                const response = await fetch('/api/trigger_auto_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `‚úÖ Auto-update triggered!<br>
                        üìä ${result.clients_notified} client(s) notified<br>
                        ${result.clients_failed > 0 ? `‚ö†Ô∏è ${result.clients_failed} client(s) failed` : '‚ú® All clients updated successfully'}`;
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.textContent = '‚ùå ' + (result.error || 'Update trigger failed');
                }
            } catch (error) {
                statusDiv.className = 'status-error';
                statusDiv.textContent = '‚ùå Auto-update failed: ' + error.message;
            }
        }

        async function testEndpoint(endpoint, method = 'GET') {
            const resultDiv = document.getElementById('api-test-result');
            const outputDiv = document.getElementById('api-test-output');
            
            resultDiv.style.display = 'block';
            outputDiv.textContent = 'Testing endpoint...';
            
            try {
                const response = await fetch(endpoint, { method });
                const data = await response.json();
                
                outputDiv.textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    resultDiv.style.border = '1px solid rgba(16, 185, 129, 0.3)';
                } else {
                    resultDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                }
            } catch (error) {
                outputDiv.textContent = 'Error: ' + error.message;
                resultDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            }
        }

        async function checkSystemStatus() {
            // Check backend status
            try {
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                
                const backendStatus = document.getElementById('backend-status');
                if (healthResponse.ok) {
                    backendStatus.innerHTML = '<span style="color: #10b981;">‚úÖ Online</span>';
                    document.getElementById('version-info').textContent = healthData.version || 'v3.2';
                } else {
                    backendStatus.innerHTML = '<span style="color: #ef4444;">‚ùå Offline</span>';
                }
            } catch (error) {
                document.getElementById('backend-status').innerHTML = '<span style="color: #ef4444;">‚ùå Unreachable</span>';
            }
            
            // Check Deploy Agent status
            try {
                const agentResponse = await fetch('http://localhost:7865/status');
                const deployStatus = document.getElementById('deploy-agent-status');
                
                if (agentResponse.ok) {
                    deployStatus.innerHTML = '<span style="color: #10b981;">‚úÖ Running</span>';
                } else {
                    deployStatus.innerHTML = '<span style="color: #fbbf24;">‚ö†Ô∏è Not running</span>';
                }
            } catch (error) {
                document.getElementById('deploy-agent-status').innerHTML = '<span style="color: #fbbf24;">‚ö†Ô∏è Not detected</span>';
            }
            
            // Check OpenAI status
            try {
                const openaiResponse = await fetch('/ping_openai');
                const openaiData = await openaiResponse.json();
                
                const openaiStatus = document.getElementById('openai-status');
                if (openaiData.openai_status === 'connected') {
                    openaiStatus.innerHTML = '<span style="color: #10b981;">‚úÖ Connected</span>';
                } else {
                    openaiStatus.innerHTML = '<span style="color: #ef4444;">‚ùå Disconnected</span>';
                }
            } catch (error) {
                document.getElementById('openai-status').innerHTML = '<span style="color: #ef4444;">‚ùå Error</span>';
            }
        }

        // Initialize WebSocket on page load
        initWebSocket();

        // Enter key support
        document.getElementById('projectQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') queryProject();
        });
    </script>
</body>
</html>
